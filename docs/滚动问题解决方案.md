# 移动端网页滚动问题解决方案

## 问题描述

在某些网站（如知乎、抖音、微博等）上浏览文章时，会弹出询问是否打开APP查看的弹窗。当用户选择"继续在当前应用查看"后，网页可能无法正常上下滑动。

## 原因分析

这种情况通常由以下原因导致：

1. **CSS样式修改**: 网站JavaScript动态设置了 `overflow: hidden` 或固定了页面高度
2. **遮罩层阻挡**: 存在透明或半透明的遮罩层阻止触摸事件传播
3. **事件监听器**: 网站添加了阻止默认滚动行为的事件监听器
4. **页面锁定**: 使用了专门的滚动锁定库（如 body-scroll-lock）

## 解决方案

我们提供了自动检测和修复功能：

### 1. 自动修复（推荐）

系统会在页面加载完成后自动注入修复脚本：

```dart
// 在 ArticleWebWidget 中自动执行
await _injectMobilePopupHandler(controller);
```

### 2. 手动修复

如果自动修复无效，可以调用手动修复方法：

```dart
// 获取 ArticleWebWidget 的 State 引用
final webWidgetState = // ... 获取state引用
await webWidgetState.forceFixScrolling();
```

### 3. 问题检测

可以先检测页面是否存在滚动问题：

```dart
final issues = await webWidgetState.detectScrollIssues();
print('滚动检测结果: $issues');
```

## 修复策略

### 基础修复
- 重置 HTML 和 BODY 的样式属性
- 移除滚动锁定相关的 CSS 类
- 恢复触摸事件的正常传播

### 遮罩层处理
- 自动检测高层级的固定定位元素
- 隐藏可疑的APP引导遮罩层
- 禁用遮罩层的指针事件

### 网站特定修复
- **知乎**: 隐藏 `.AppBanner`、`.MobileAppBanner` 等元素
- **微博**: 处理 `.m-text-download`、`.download-layer` 等
- **今日头条/抖音**: 移除 `.download-bar`、`.app-download-bar` 等

### 强制覆盖
使用 `!important` CSS 规则强制恢复滚动：
```css
html, body {
  overflow-y: auto !important;
  height: auto !important;
  position: static !important;
}
```

## 使用说明

### 在文章页面中使用

如果遇到滚动问题，可以：

1. 等待自动修复生效（通常在页面加载后1-5秒内）
2. 如果仍有问题，尝试刷新页面
3. 必要时可以添加手动修复按钮供用户点击

### 调试信息

系统会在控制台输出详细的检测和修复日志：

```
📱 移动端弹窗处理脚本已启动
🔍 开始检测页面滚动问题...
📊 滚动检测结果: ✅ 是 / ❌ 否
🔧 开始综合滚动修复...
🗑️ 隐藏问题遮罩: DIV .app-banner
✅ 综合修复完成，修复了 3 个问题
```

## 注意事项

1. **兼容性**: 修复脚本会尽量避免破坏页面原有功能
2. **性能**: 使用防抖和延迟执行，避免频繁执行
3. **安全性**: 只修改样式属性，不删除DOM元素
4. **监控**: 使用 MutationObserver 监听页面变化，自动重新修复

## 常见问题

### Q: 修复后页面显示异常怎么办？
A: 刷新页面即可恢复，修复脚本不会永久改变页面结构。

### Q: 某些网站的修复效果不好？
A: 可以在 `ScrollFixUtils.applyComprehensiveFix()` 中添加针对该网站的特定修复逻辑。

### Q: 如何确认修复是否成功？
A: 检查控制台日志或调用 `detectScrollIssues()` 方法查看检测结果。

## 后续优化

- [ ] 支持更多网站的特定修复规则
- [ ] 添加用户反馈机制，收集修复效果数据
- [ ] 考虑使用机器学习识别更复杂的滚动阻止模式
- [ ] 提供用户自定义修复规则的界面 