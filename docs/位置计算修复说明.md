# 标注菜单位置计算修复说明

## 问题描述
用户反馈操作栏显示在文字中间，遮挡了标注内容，影响阅读体验。

## 问题分析

### 原始问题
1. **间距不足**：菜单与标注之间的间距太小（原来只有10px）
2. **位置计算**：没有充分考虑菜单尺寸与标注的关系
3. **缺乏验证**：没有检测菜单是否会与标注内容重叠

### 对比SelectionMenuLogic
参考现有的`SelectionMenuLogic`实现，发现：
- 使用了更大的间距（-54px和-20px）
- 位置计算更加保守，确保不遮挡内容

## 修复方案

### 1. 调整间距计算
```dart
// 修复前
menuY = highlightRectOnScreen.top - menuHeight - 10;    // 间距太小
menuY = highlightRectOnScreen.bottom + 10;

// 修复后  
menuY = highlightRectOnScreen.top - menuHeight - 8;     // 适中的间距
menuY = highlightRectOnScreen.bottom + 8;
```

### 2. 改进位置验证
添加了菜单与标注重叠检测：
```dart
final menuRect = Rect.fromLTWH(menuX, menuY, menuWidth, menuHeight);
final overlap = menuRect.overlaps(highlightRectOnScreen);
if (overlap) {
  getLogger().w('⚠️ 警告：菜单可能与标注重叠！');
}
```

### 3. 增强调试信息
新增详细的位置调试日志：
- 标注区域的屏幕坐标
- 标注中心点坐标
- 菜单尺寸信息
- 重叠检测结果

## 修复效果

### 预期改进
1. **避免遮挡**：菜单不再显示在标注文字上方
2. **合理间距**：菜单与标注之间有足够的视觉间距
3. **智能定位**：优先上方显示，空间不足时自动下移
4. **调试友好**：提供详细日志便于问题定位

### 新的日志输出
```
📍 标注区域(屏幕): Rect.fromLTRB(100.0, 200.0, 250.0, 220.0)
📍 标注中心点: (175, 210)
📍 可用空间: 上方=140px, 下方=400px
📍 菜单尺寸: 180x60
📍 最终菜单位置: x=90, y=132
✅ 菜单位置验证通过，不会遮挡标注
```

## 测试验证

### 测试场景
1. **标注在页面顶部**：菜单应显示在标注下方
2. **标注在页面底部**：菜单应显示在标注上方  
3. **标注在页面中间**：菜单应显示在标注上方（默认）
4. **窄屏幕情况**：菜单应避免超出屏幕边界

### 验证要点
- [ ] 菜单不遮挡标注文字
- [ ] 间距适中，视觉上舒适
- [ ] 不超出屏幕边界
- [ ] 日志显示位置计算正确
- [ ] 重叠检测工作正常

## 后续优化方向

### 潜在改进
1. **动态间距**：根据标注高度调整间距
2. **动画效果**：添加菜单出现的平滑动画
3. **自适应尺寸**：根据屏幕大小调整菜单尺寸
4. **边界检测**：更智能的边界避让逻辑

### SelectionMenuLogic的问题
在修复过程中发现`SelectionMenuLogic`中也存在类似问题：
```dart
double menuX = (menuWidth / 2);  // 这个计算是错误的
```
应该修正为：
```dart
double menuX = selectionRectOnScreen.center.dx - (menuWidth / 2);
```

## 使用建议

### 开发时调试
1. 观察控制台的位置计算日志
2. 检查是否有重叠警告
3. 验证菜单显示位置是否合理

### 问题排查
1. **菜单仍然遮挡**：检查间距计算和边界框数据
2. **菜单位置偏移**：检查WebView坐标转换
3. **菜单显示异常**：检查Overlay创建和显示逻辑 