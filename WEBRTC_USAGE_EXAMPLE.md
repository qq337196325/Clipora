# WebRTC 数据同步使用示例

## 快速开始

### 1. 准备工作

确保你的信令服务器正在运行：
```bash
# 在服务器上启动信令服务器
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. 使用步骤

#### 设备A操作：

1. **打开应用**
   - 进入设置页面
   - 点击"数据同步"

2. **连接信令服务器**
   - 点击"连接信令服务器"按钮
   - 等待状态显示"已连接"

3. **创建或加入房间**
   - 使用默认房间ID或输入自定义房间ID
   - 点击"加入房间"按钮

#### 设备B操作：

1. **连接信令服务器**
   - 重复设备A的步骤1-2

2. **加入同一房间**
   - 输入与设备A相同的房间ID
   - 点击"加入房间"按钮
   - 此时两个设备都能看到对方出现在用户列表中

#### 建立WebRTC连接：

1. **在任一设备上**
   - 从下拉列表中选择目标用户
   - 点击"建立WebRTC连接"按钮
   - 等待WebRTC连接状态显示"已连接"

2. **开始数据传输**
   - 点击"发送测试"发送测试消息
   - 点击"发送文件"发送示例文件

## 配置说明

### 服务器配置

当前配置的服务器地址：
- **信令服务器**: `ws://111.230.32.118:8000/webrtc/ws`
- **STUN服务器**: `stun:coturn.clipora.cc:23388`
- **TURN服务器**: `turn:coturn.clipora.cc:23388`
  - 用户名: `clipora`
  - 密码: `clipora123`

### 修改服务器配置

如需修改服务器配置，编辑 `lib/view/data_sync/data_sync_page.dart` 文件：

```dart
// 信令服务器配置
static const String _signalingServerUrl = 'ws://your-server:8000/webrtc/ws';

// STUN/TURN 服务器配置
static const Map<String, dynamic> _rtcConfiguration = {
  'iceServers': [
    {
      'urls': 'stun:your-stun-server:3478',
    },
    {
      'urls': 'turn:your-turn-server:3478',
      'username': 'your-username',
      'credential': 'your-password',
    },
  ],
  'iceCandidatePoolSize': 10,
};
```

## 故障排除

### 常见问题

1. **信令服务器连接失败**
   ```
   错误: 连接信令服务器失败
   解决: 检查服务器是否运行，网络是否可达
   ```

2. **WebRTC连接失败**
   ```
   错误: WebRTC连接状态显示"连接失败"
   解决: 检查STUN/TURN服务器配置，确保网络环境支持WebRTC
   ```

3. **用户列表为空**
   ```
   错误: 加入房间后看不到其他用户
   解决: 确保其他用户也加入了相同的房间ID
   ```

### 调试技巧

1. **查看日志**
   - 所有操作都会在"同步日志"区域显示
   - 注意查看错误信息和连接状态变化

2. **网络检查**
   - 确保设备能访问信令服务器
   - 测试STUN/TURN服务器连通性

3. **分步测试**
   - 先确保信令服务器连接正常
   - 再测试房间加入功能
   - 最后测试WebRTC连接

## 高级用法

### 自定义房间管理

```dart
// 可以通过修改房间ID实现不同的使用场景
_roomId = 'project_sync_room';  // 项目同步房间
_roomId = 'team_meeting_room';  // 团队会议房间
_roomId = 'file_share_room';    // 文件共享房间
```

### 扩展文件传输

当前实现支持基本的文件传输，可以扩展为：
- 支持选择任意文件
- 显示传输进度
- 支持大文件分块传输
- 添加文件完整性校验

### 安全增强

- 添加房间密码验证
- 实现端到端加密
- 添加用户身份验证
- 限制文件类型和大小

## 性能优化

1. **网络优化**
   - 使用专用的TURN服务器
   - 配置合适的ICE候选者池大小
   - 优化数据块大小

2. **UI优化**
   - 添加连接进度指示器
   - 实现自动重连机制
   - 优化日志显示性能

3. **资源管理**
   - 及时释放WebRTC连接
   - 清理无用的数据通道
   - 管理内存使用

---

**注意**: 这是一个基础实现，生产环境使用时请考虑安全性、稳定性和性能优化。