

## 多平台客户端与服务端数据同步方案；

1. 客户端发送请求获取服务器当前时间戳；
2. 将当前时间戳存储到客户端本地；
3. 拉取该时间戳的所有表数据，返回给到客户端；
4. 客户端将这些数据写入到本地数据库；


## 改进后的数据同步方案建议

#### 核心概念
*   **时间戳 (Timestamp)**: 所有需要同步的数据表都应包含 `created_at` 和 `updated_at` 字段，以追踪记录的创建和最后修改时间。
*   **软删除 (Soft Delete)**: 使用 `is_deleted` 标志位来处理删除操作。
*   **上次同步时间戳 (lastSyncTimestamp)**: 客户端本地持久化存储一个时间戳，记录上次成功与服务器同步的时间点。

#### 1. 首次同步（或重置后同步）
1.  **客户端**: 向服务器发起"全量同步"请求。
2.  **服务器**:
    a. 查询当前服务器时间 `server_now`。
    b. 查询用户的所有有效数据 (`is_deleted = false`)。
    c. 将 `server_now` 和所有数据返回给客户端。
3.  **客户端**:
    a. 清空本地相关的数据库表。
    b. 将从服务器获取的数据写入本地数据库。
    c. 将服务器返回的 `server_now` 保存为本地的 `lastSyncTimestamp`。

#### 2. 增量同步（常规同步流程）
这个流程分为"推送本地变更"和"拉取远程变更"两个阶段。

**阶段A：推送本地变更 (Client -> Server)**
1.  **客户端**: 找出本地数据库中 `updated_at > lastSyncTimestamp` 的所有记录（包括新增、修改和软删除的记录）。
2.  **客户端**: 将这些变更数据打包，发送给服务器。
3.  **服务器**:
    a. 接收客户端的变更数据。
    b. 遍历每一条变更记录，并与服务器上的数据进行冲突检测（例如，比较 `updated_at` 时间戳，服务器上的更新时间更晚则视为冲突）。
    c. 应用变更到数据库，并处理冲突。
    d. 向客户端返回处理结果。

**阶段B：拉取远程变更 (Server -> Client)**
1.  **客户端**: 向服务器发起"增量同步"请求，并带上本地存储的 `lastSyncTimestamp`。
2.  **服务器**:
    a. 查询当前服务器时间 `server_now`。
    b. 基于客户端传来的 `lastSyncTimestamp`，查询所有 `updated_at > lastSyncTimestamp` 的记录（包括新增、修改和软删除的记录）。
    c. 将查询到的变更数据和 `server_now` 一同返回给客户端。
3.  **客户端**:
    a. 在一个数据库事务中，处理从服务器返回的变更数据：
        - 如果是新记录，则插入。
        - 如果是现有记录的更新，则更新。
        - 如果记录被标记为 `is_deleted`，则从本地数据库中物理删除或也进行软删除。
    b. 如果事务成功完成，则将本地的 `lastSyncTimestamp` 更新为服务器返回的 `server_now`。



