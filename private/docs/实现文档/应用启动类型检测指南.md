# Flutteråº”ç”¨å¯åŠ¨ç±»å‹æ£€æµ‹æŒ‡å—

## æ¦‚è¿°

åœ¨Flutteråº”ç”¨ä¸­ï¼Œæ­£ç¡®åˆ¤æ–­åº”ç”¨çš„å¯åŠ¨æ–¹å¼å¯¹äºæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦ã€‚æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨Flutteråº”ç”¨ä¸­æ£€æµ‹å’Œå¤„ç†ä¸åŒçš„å¯åŠ¨ç±»å‹ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•åŒºåˆ†æ­£å¸¸å¯åŠ¨å’Œåˆ†äº«å¯åŠ¨ã€‚

## å¯åŠ¨ç±»å‹åˆ†ç±»

### 1. æ­£å¸¸å¯åŠ¨ (Normal Launch)
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡»åº”ç”¨å›¾æ ‡
- **ç‰¹å¾**: åº”ç”¨ä»æ¡Œé¢æˆ–åº”ç”¨åˆ—è¡¨å¯åŠ¨
- **å¤„ç†**: å®Œæ•´çš„åº”ç”¨åˆå§‹åŒ–æµç¨‹

### 2. åˆ†äº«å¯åŠ¨ (Share Launch)
- **è§¦å‘æ–¹å¼**: å…¶ä»–åº”ç”¨é€šè¿‡ç³»ç»Ÿåˆ†äº«åŠŸèƒ½å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨
- **ç‰¹å¾**: æºå¸¦åˆ†äº«å†…å®¹æ•°æ®
- **å¤„ç†**: ä¼˜å…ˆå¤„ç†åˆ†äº«å†…å®¹ï¼Œå¿«é€Ÿå¯åŠ¨

### 3. æ·±å±‚é“¾æ¥å¯åŠ¨ (Deep Link Launch)
- **è§¦å‘æ–¹å¼**: é€šè¿‡URL schemeæˆ–Universal Links
- **ç‰¹å¾**: æºå¸¦ç‰¹å®šçš„é“¾æ¥å‚æ•°
- **å¤„ç†**: æ ¹æ®é“¾æ¥å‚æ•°å¯¼èˆªåˆ°ç‰¹å®šé¡µé¢

### 4. é€šçŸ¥å¯åŠ¨ (Notification Launch)
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡»æ¨é€é€šçŸ¥
- **ç‰¹å¾**: æºå¸¦é€šçŸ¥ç›¸å…³æ•°æ®
- **å¤„ç†**: æ ¹æ®é€šçŸ¥å†…å®¹æ‰§è¡Œç›¸åº”æ“ä½œ

## æ ¸å¿ƒå®ç°

### 1. AppLaunchDetector ç±»

`AppLaunchDetector` æ˜¯æ ¸å¿ƒçš„å¯åŠ¨ç±»å‹æ£€æµ‹å™¨ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼è®¾è®¡ï¼š

```dart
// è·å–æ£€æµ‹å™¨å®ä¾‹
final detector = AppLaunchDetector.instance;

// æ£€æµ‹å¯åŠ¨ç±»å‹
final launchType = await detector.detectLaunchType();

// è·å–æ£€æµ‹ç»“æœ
print('å¯åŠ¨ç±»å‹: ${detector.getLaunchTypeDescription()}');
print('æ˜¯å¦åˆ†äº«å¯åŠ¨: ${detector.isShareLaunch}');
print('å¯åŠ¨è¯¦æƒ…: ${detector.getLaunchInfo()}');
```

### 2. æ£€æµ‹æ–¹æ³•è¯¦è§£

#### æ–¹æ³•1: æ£€æŸ¥åˆ†äº«åª’ä½“å†…å®¹
```dart
final initialMedia = await ReceiveSharingIntent.instance.getInitialMedia();
if (initialMedia.isNotEmpty) {
  // æ£€æµ‹åˆ°åˆ†äº«å¯åŠ¨
  // åˆ†æåª’ä½“ç±»å‹ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶ç­‰
}
```

#### æ–¹æ³•2: iOS Share Extensionæ£€æµ‹
```dart
if (Platform.isIOS) {
  // æ£€æŸ¥App Groupå…±äº«æ•°æ®
  // é€‚ç”¨äºæœ‰Share Extensionçš„iOSåº”ç”¨
}
```

#### æ–¹æ³•3: æ·±å±‚é“¾æ¥æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
```dart
// ä½¿ç”¨app_linksåŒ…æ£€æµ‹æ·±å±‚é“¾æ¥å¯åŠ¨
// final Uri? initialLink = await _checkInitialLink();
```

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨åº”ç”¨å¯åŠ¨æ—¶ä½¿ç”¨

```dart
// åœ¨TransferRouteæˆ–main.dartä¸­
class _TransferRouteState extends State<TransferRoute> with TransferRouteBLoC {
  void _init() async {
    // åŸºç¡€æœåŠ¡åˆå§‹åŒ–
    await GetStorage.init();
    final dbService = Get.put(DatabaseService(), permanent: true);
    await dbService.initDb();

    // ğŸ¯ æ ¸å¿ƒï¼šæ£€æµ‹å¯åŠ¨ç±»å‹
    final detector = AppLaunchDetector.instance;
    final launchType = await detector.detectLaunchType();
    
    // è·å–è¯¦ç»†ä¿¡æ¯
    final launchInfo = detector.getLaunchInfo();
    getLogger().i('å¯åŠ¨ç±»å‹: ${launchInfo['description']}');
    
    // æ ¹æ®å¯åŠ¨ç±»å‹é€‰æ‹©ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥
    if (detector.isShareLaunch) {
      await _handleShareLaunch(detector);
    } else {
      await _handleNormalLaunch();
    }
  }
  
  // å¤„ç†åˆ†äº«å¯åŠ¨
  Future<void> _handleShareLaunch(AppLaunchDetector detector) async {
    // 1. å¿«é€Ÿåˆå§‹åŒ–æ ¸å¿ƒæœåŠ¡
    final shareService = Get.put(ShareService(), permanent: true);
    
    // 2. å¤„ç†åˆ†äº«å†…å®¹
    final initialMedia = detector.initialMediaFiles;
    if (initialMedia.isNotEmpty) {
      shareService.processInitialShare(initialMedia);
    }
    
    // 3. å¯¼èˆªåˆ°ç›¸åº”é¡µé¢
    context.go('/index'); // æˆ–åˆ†äº«å¤„ç†é¡µé¢
  }
  
  // å¤„ç†æ­£å¸¸å¯åŠ¨
  Future<void> _handleNormalLaunch() async {
    // å®Œæ•´çš„æœåŠ¡åˆå§‹åŒ–
    await _initAllServices();
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶å¯¼èˆª
    await _checkAuthAndNavigate();
  }
}
```

### åœ¨å…¶ä»–é¡µé¢ä¸­è·å–å¯åŠ¨ä¿¡æ¯

```dart
class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final detector = AppLaunchDetector.instance;
    
    return Scaffold(
      appBar: AppBar(
        title: Text('åº”ç”¨é¦–é¡µ'),
        subtitle: Text('å¯åŠ¨æ–¹å¼: ${detector.getLaunchTypeDescription()}'),
      ),
      body: Column(
        children: [
          if (detector.isShareLaunch)
            Card(
              child: ListTile(
                leading: Icon(Icons.share),
                title: Text('æ£€æµ‹åˆ°åˆ†äº«å¯åŠ¨'),
                subtitle: Text('å…±äº«æ–‡ä»¶æ•°: ${detector.initialMediaFiles.length}'),
              ),
            ),
          // å…¶ä»–å†…å®¹...
        ],
      ),
    );
  }
}
```

## åˆ†äº«å†…å®¹ç±»å‹å¤„ç†

### æ–‡æœ¬åˆ†äº«
```dart
if (detector.launchType == AppLaunchType.shareText) {
  final textMedia = detector.initialMediaFiles
      .firstWhere((media) => media.type == SharedMediaType.text);
  final sharedText = textMedia.message ?? textMedia.path;
  
  // å¤„ç†åˆ†äº«çš„æ–‡æœ¬å†…å®¹
  // å¯èƒ½åŒ…å«URLã€çº¯æ–‡æœ¬ç­‰
}
```

### åª’ä½“æ–‡ä»¶åˆ†äº«
```dart
if (detector.launchType == AppLaunchType.shareMedia) {
  for (final media in detector.initialMediaFiles) {
    switch (media.type) {
      case SharedMediaType.image:
        // å¤„ç†å›¾ç‰‡
        break;
      case SharedMediaType.video:
        // å¤„ç†è§†é¢‘
        break;
      case SharedMediaType.file:
        // å¤„ç†å…¶ä»–æ–‡ä»¶
        break;
    }
  }
}
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### åˆ†äº«å¯åŠ¨ä¼˜åŒ–
1. **æœåŠ¡åˆå§‹åŒ–ä¼˜åŒ–**: åˆ†äº«å¯åŠ¨æ—¶åªåˆå§‹åŒ–å¿…è¦çš„æ ¸å¿ƒæœåŠ¡
2. **UIå¿«é€Ÿå“åº”**: ä¼˜å…ˆæ˜¾ç¤ºåˆ†äº«å†…å®¹å¤„ç†ç•Œé¢
3. **åå°å¤„ç†**: å°†å¤æ‚çš„åˆ†äº«å†…å®¹å¤„ç†æ”¾åœ¨åå°è¿›è¡Œ

```dart
// åˆ†äº«å¯åŠ¨çš„ç²¾ç®€åˆå§‹åŒ–
Future<void> _initCoreServices() async {
  // åªåˆå§‹åŒ–å¿…è¦æœåŠ¡
  Get.put(ShareService(), permanent: true);
  // å…¶ä»–æœåŠ¡å¯ä»¥å»¶è¿Ÿåˆå§‹åŒ–
}

// æ­£å¸¸å¯åŠ¨çš„å®Œæ•´åˆå§‹åŒ–
Future<void> _initAllServices() async {
  // åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
  Get.put(ShareService(), permanent: true);
  Get.put(SyncService(), permanent: true);
  Get.put(ArticleService(), permanent: true);
  // æ›´å¤šæœåŠ¡...
}
```

## è°ƒè¯•å’Œç›‘æ§

### å¯åŠ¨ä¿¡æ¯æ—¥å¿—
```dart
final launchInfo = detector.getLaunchInfo();
getLogger().i('ğŸ“Š åº”ç”¨å¯åŠ¨ç»Ÿè®¡: $launchInfo');

// è¾“å‡ºç¤ºä¾‹:
// {
//   "type": "shareText",
//   "description": "åˆ†äº«æ–‡æœ¬å¯åŠ¨",
//   "isShareLaunch": true,
//   "isNormalLaunch": false,
//   "mediaFilesCount": 1,
//   "additionalInfo": "Text: è¿™æ˜¯åˆ†äº«çš„æ–‡æœ¬å†…å®¹...",
//   "timestamp": "2024-01-15T10:30:00.000Z"
// }
```

### åŸ‹ç‚¹ç»Ÿè®¡
```dart
// è®°å½•å¯åŠ¨ç±»å‹ç»Ÿè®¡
ClientLog.buryingPoint(
  eventName: 'app_launch',
  parameters: detector.getLaunchInfo(),
);
```

## é”™è¯¯å¤„ç†

### æ£€æµ‹å¤±è´¥å¤„ç†
```dart
try {
  final launchType = await detector.detectLaunchType();
  // æ­£å¸¸å¤„ç†é€»è¾‘
} catch (e) {
  getLogger().e('å¯åŠ¨ç±»å‹æ£€æµ‹å¤±è´¥: $e');
  // é™çº§åˆ°æ­£å¸¸å¯åŠ¨å¤„ç†
  await _handleNormalLaunch();
}
```

### åˆ†äº«å†…å®¹å¤„ç†å¤±è´¥
```dart
try {
  if (detector.isShareLaunch) {
    await _handleShareLaunch(detector);
  }
} catch (e) {
  getLogger().e('åˆ†äº«å¯åŠ¨å¤„ç†å¤±è´¥: $e');
  // é™çº§åˆ°æ­£å¸¸å¯åŠ¨æµç¨‹
  await _handleNormalLaunch();
}
```

## æœ€ä½³å®è·µ

### 1. å¯åŠ¨æ—¶æœº
- åœ¨åº”ç”¨æœ€æ—©æœŸè¿›è¡Œæ£€æµ‹ï¼ˆå¦‚main.dartæˆ–ç¬¬ä¸€ä¸ªé¡µé¢ï¼‰
- åœ¨å¿…è¦æœåŠ¡åˆå§‹åŒ–ä¹‹åï¼ŒUIæ¸²æŸ“ä¹‹å‰

### 2. çŠ¶æ€ç®¡ç†
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿æ£€æµ‹ç»“æœçš„ä¸€è‡´æ€§
- åœ¨åº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒæ£€æµ‹ç»“æœ

### 3. ç”¨æˆ·ä½“éªŒ
- åˆ†äº«å¯åŠ¨æ—¶æä¾›å¿«é€Ÿå“åº”
- æ˜¾ç¤ºé€‚å½“çš„åŠ è½½çŠ¶æ€
- å¤„ç†åˆ†äº«å†…å®¹å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥

### 4. æµ‹è¯•éªŒè¯
- æµ‹è¯•æ­£å¸¸å¯åŠ¨æµç¨‹
- æµ‹è¯•å„ç§ç±»å‹çš„åˆ†äº«å¯åŠ¨ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
- æµ‹è¯•å¼‚å¸¸æƒ…å†µçš„å¤„ç†

## æ‰©å±•åŠŸèƒ½

### è‡ªå®šä¹‰æ£€æµ‹é€»è¾‘
```dart
// å¯ä»¥æ‰©å±•AppLaunchDetectorç±»æ·»åŠ è‡ªå®šä¹‰æ£€æµ‹
class CustomLaunchDetector extends AppLaunchDetector {
  @override
  Future<AppLaunchType> detectLaunchType() async {
    // å…ˆæ‰§è¡Œçˆ¶ç±»æ£€æµ‹
    await super.detectLaunchType();
    
    // æ·»åŠ è‡ªå®šä¹‰æ£€æµ‹é€»è¾‘
    if (await _checkCustomLaunchCondition()) {
      return AppLaunchType.custom;
    }
    
    return launchType;
  }
}
```

### å¤šå¹³å°é€‚é…
```dart
// Androidç‰¹å®šæ£€æµ‹
if (Platform.isAndroid) {
  // Android Intentæ£€æµ‹
}

// iOSç‰¹å®šæ£€æµ‹
if (Platform.isIOS) {
  // iOS Universal Linksæ£€æµ‹
  // Share Extensionæ£€æµ‹
}
```

## æ€»ç»“

é€šè¿‡ä½¿ç”¨ `AppLaunchDetector` ç±»å’Œç›¸å…³çš„æ£€æµ‹æ–¹æ³•ï¼Œå¯ä»¥å‡†ç¡®è¯†åˆ«Flutteråº”ç”¨çš„å¯åŠ¨ç±»å‹ï¼Œä»è€Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ€§èƒ½ä¼˜åŒ–ã€‚å…³é”®è¦ç‚¹ï¼š

1. **å‡†ç¡®æ£€æµ‹**: ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿æ£€æµ‹çš„å‡†ç¡®æ€§
2. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®å¯åŠ¨ç±»å‹é€‰æ‹©ä¸åŒçš„åˆå§‹åŒ–ç­–ç•¥
3. **ç”¨æˆ·ä½“éªŒ**: ä¸ºä¸åŒå¯åŠ¨ç±»å‹æä¾›é€‚å½“çš„ç”¨æˆ·ç•Œé¢
4. **é”™è¯¯å¤„ç†**: å¦¥å–„å¤„ç†æ£€æµ‹å¤±è´¥å’Œå¼‚å¸¸æƒ…å†µ
5. **ç›‘æ§ç»Ÿè®¡**: è®°å½•å¯åŠ¨ç»Ÿè®¡æ•°æ®ç”¨äºåˆ†æå’Œä¼˜åŒ– 