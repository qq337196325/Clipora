# Flutter应用启动类型检测指南

## 概述

在Flutter应用中，正确判断应用的启动方式对于提供良好的用户体验至关重要。本指南详细介绍了如何在Flutter应用中检测和处理不同的启动类型，特别是如何区分正常启动和分享启动。

## 启动类型分类

### 1. 正常启动 (Normal Launch)
- **触发方式**: 用户点击应用图标
- **特征**: 应用从桌面或应用列表启动
- **处理**: 完整的应用初始化流程

### 2. 分享启动 (Share Launch)
- **触发方式**: 其他应用通过系统分享功能启动我们的应用
- **特征**: 携带分享内容数据
- **处理**: 优先处理分享内容，快速启动

### 3. 深层链接启动 (Deep Link Launch)
- **触发方式**: 通过URL scheme或Universal Links
- **特征**: 携带特定的链接参数
- **处理**: 根据链接参数导航到特定页面

### 4. 通知启动 (Notification Launch)
- **触发方式**: 用户点击推送通知
- **特征**: 携带通知相关数据
- **处理**: 根据通知内容执行相应操作

## 核心实现

### 1. AppLaunchDetector 类

`AppLaunchDetector` 是核心的启动类型检测器，采用单例模式设计：

```dart
// 获取检测器实例
final detector = AppLaunchDetector.instance;

// 检测启动类型
final launchType = await detector.detectLaunchType();

// 获取检测结果
print('启动类型: ${detector.getLaunchTypeDescription()}');
print('是否分享启动: ${detector.isShareLaunch}');
print('启动详情: ${detector.getLaunchInfo()}');
```

### 2. 检测方法详解

#### 方法1: 检查分享媒体内容
```dart
final initialMedia = await ReceiveSharingIntent.instance.getInitialMedia();
if (initialMedia.isNotEmpty) {
  // 检测到分享启动
  // 分析媒体类型：文本、图片、视频、文件等
}
```

#### 方法2: iOS Share Extension检测
```dart
if (Platform.isIOS) {
  // 检查App Group共享数据
  // 适用于有Share Extension的iOS应用
}
```

#### 方法3: 深层链接检测（可选）
```dart
// 使用app_links包检测深层链接启动
// final Uri? initialLink = await _checkInitialLink();
```

## 使用示例

### 在应用启动时使用

```dart
// 在TransferRoute或main.dart中
class _TransferRouteState extends State<TransferRoute> with TransferRouteBLoC {
  void _init() async {
    // 基础服务初始化
    await GetStorage.init();
    final dbService = Get.put(DatabaseService(), permanent: true);
    await dbService.initDb();

    // 🎯 核心：检测启动类型
    final detector = AppLaunchDetector.instance;
    final launchType = await detector.detectLaunchType();
    
    // 获取详细信息
    final launchInfo = detector.getLaunchInfo();
    getLogger().i('启动类型: ${launchInfo['description']}');
    
    // 根据启动类型选择不同的初始化策略
    if (detector.isShareLaunch) {
      await _handleShareLaunch(detector);
    } else {
      await _handleNormalLaunch();
    }
  }
  
  // 处理分享启动
  Future<void> _handleShareLaunch(AppLaunchDetector detector) async {
    // 1. 快速初始化核心服务
    final shareService = Get.put(ShareService(), permanent: true);
    
    // 2. 处理分享内容
    final initialMedia = detector.initialMediaFiles;
    if (initialMedia.isNotEmpty) {
      shareService.processInitialShare(initialMedia);
    }
    
    // 3. 导航到相应页面
    context.go('/index'); // 或分享处理页面
  }
  
  // 处理正常启动
  Future<void> _handleNormalLaunch() async {
    // 完整的服务初始化
    await _initAllServices();
    
    // 检查登录状态并导航
    await _checkAuthAndNavigate();
  }
}
```

### 在其他页面中获取启动信息

```dart
class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final detector = AppLaunchDetector.instance;
    
    return Scaffold(
      appBar: AppBar(
        title: Text('应用首页'),
        subtitle: Text('启动方式: ${detector.getLaunchTypeDescription()}'),
      ),
      body: Column(
        children: [
          if (detector.isShareLaunch)
            Card(
              child: ListTile(
                leading: Icon(Icons.share),
                title: Text('检测到分享启动'),
                subtitle: Text('共享文件数: ${detector.initialMediaFiles.length}'),
              ),
            ),
          // 其他内容...
        ],
      ),
    );
  }
}
```

## 分享内容类型处理

### 文本分享
```dart
if (detector.launchType == AppLaunchType.shareText) {
  final textMedia = detector.initialMediaFiles
      .firstWhere((media) => media.type == SharedMediaType.text);
  final sharedText = textMedia.message ?? textMedia.path;
  
  // 处理分享的文本内容
  // 可能包含URL、纯文本等
}
```

### 媒体文件分享
```dart
if (detector.launchType == AppLaunchType.shareMedia) {
  for (final media in detector.initialMediaFiles) {
    switch (media.type) {
      case SharedMediaType.image:
        // 处理图片
        break;
      case SharedMediaType.video:
        // 处理视频
        break;
      case SharedMediaType.file:
        // 处理其他文件
        break;
    }
  }
}
```

## 性能优化策略

### 分享启动优化
1. **服务初始化优化**: 分享启动时只初始化必要的核心服务
2. **UI快速响应**: 优先显示分享内容处理界面
3. **后台处理**: 将复杂的分享内容处理放在后台进行

```dart
// 分享启动的精简初始化
Future<void> _initCoreServices() async {
  // 只初始化必要服务
  Get.put(ShareService(), permanent: true);
  // 其他服务可以延迟初始化
}

// 正常启动的完整初始化
Future<void> _initAllServices() async {
  // 初始化所有服务
  Get.put(ShareService(), permanent: true);
  Get.put(SyncService(), permanent: true);
  Get.put(ArticleService(), permanent: true);
  // 更多服务...
}
```

## 调试和监控

### 启动信息日志
```dart
final launchInfo = detector.getLaunchInfo();
getLogger().i('📊 应用启动统计: $launchInfo');

// 输出示例:
// {
//   "type": "shareText",
//   "description": "分享文本启动",
//   "isShareLaunch": true,
//   "isNormalLaunch": false,
//   "mediaFilesCount": 1,
//   "additionalInfo": "Text: 这是分享的文本内容...",
//   "timestamp": "2024-01-15T10:30:00.000Z"
// }
```

### 埋点统计
```dart
// 记录启动类型统计
ClientLog.buryingPoint(
  eventName: 'app_launch',
  parameters: detector.getLaunchInfo(),
);
```

## 错误处理

### 检测失败处理
```dart
try {
  final launchType = await detector.detectLaunchType();
  // 正常处理逻辑
} catch (e) {
  getLogger().e('启动类型检测失败: $e');
  // 降级到正常启动处理
  await _handleNormalLaunch();
}
```

### 分享内容处理失败
```dart
try {
  if (detector.isShareLaunch) {
    await _handleShareLaunch(detector);
  }
} catch (e) {
  getLogger().e('分享启动处理失败: $e');
  // 降级到正常启动流程
  await _handleNormalLaunch();
}
```

## 最佳实践

### 1. 启动时机
- 在应用最早期进行检测（如main.dart或第一个页面）
- 在必要服务初始化之后，UI渲染之前

### 2. 状态管理
- 使用单例模式确保检测结果的一致性
- 在应用生命周期内保持检测结果

### 3. 用户体验
- 分享启动时提供快速响应
- 显示适当的加载状态
- 处理分享内容失败时的降级策略

### 4. 测试验证
- 测试正常启动流程
- 测试各种类型的分享启动（文本、图片、文件等）
- 测试异常情况的处理

## 扩展功能

### 自定义检测逻辑
```dart
// 可以扩展AppLaunchDetector类添加自定义检测
class CustomLaunchDetector extends AppLaunchDetector {
  @override
  Future<AppLaunchType> detectLaunchType() async {
    // 先执行父类检测
    await super.detectLaunchType();
    
    // 添加自定义检测逻辑
    if (await _checkCustomLaunchCondition()) {
      return AppLaunchType.custom;
    }
    
    return launchType;
  }
}
```

### 多平台适配
```dart
// Android特定检测
if (Platform.isAndroid) {
  // Android Intent检测
}

// iOS特定检测
if (Platform.isIOS) {
  // iOS Universal Links检测
  // Share Extension检测
}
```

## 总结

通过使用 `AppLaunchDetector` 类和相关的检测方法，可以准确识别Flutter应用的启动类型，从而提供更好的用户体验和性能优化。关键要点：

1. **准确检测**: 使用多种方法确保检测的准确性
2. **性能优化**: 根据启动类型选择不同的初始化策略
3. **用户体验**: 为不同启动类型提供适当的用户界面
4. **错误处理**: 妥善处理检测失败和异常情况
5. **监控统计**: 记录启动统计数据用于分析和优化 