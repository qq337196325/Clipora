# 数据同步功能

## 功能概述

数据同步功能使用 WebRTC 技术和专用信令服务器实现设备间的点对点文件传输和数据同步。

## 主要特性

- **信令服务器**: 使用专用信令服务器 (111.230.32.118:8000) 进行连接协调
- **STUN/TURN 服务器**: 使用 coturn.clipora.cc:23388 进行 NAT 穿透
- **房间管理**: 支持多房间，用户可以加入/离开房间进行文件共享
- **点对点连接**: 使用 WebRTC 建立直接的设备间连接
- **文件传输**: 支持文件的发送和接收
- **实时日志**: 显示连接状态和传输进度
- **用户管理**: 自动处理用户连接/断开，维护房间用户列表

## 使用方法

### 连接流程

1. **连接信令服务器**: 
   - 点击"连接信令服务器"按钮
   - 系统会自动生成用户ID并连接到信令服务器

2. **加入房间**:
   - 输入房间ID（或使用默认生成的房间ID）
   - 点击"加入房间"按钮
   - 等待其他用户加入同一房间

3. **建立WebRTC连接**:
   - 从下拉列表中选择目标用户
   - 点击"建立WebRTC连接"按钮
   - 系统会自动处理 SDP 交换和 ICE 候选者协商

4. **数据传输**:
   - 连接建立后，可以发送测试消息或文件
   - 点击"发送测试"发送测试消息
   - 点击"发送文件"发送示例文件

### 状态指示

- **信令服务器状态**: 显示与信令服务器的连接状态
- **WebRTC连接状态**: 显示点对点连接状态
- **房间用户列表**: 显示当前房间内的其他用户

## 技术实现

### 信令服务器配置

```dart
static const String _signalingServerUrl = 'ws://111.230.32.118:8000/webrtc/ws';
```

### STUN/TURN 服务器配置

```dart
static const Map<String, dynamic> _rtcConfiguration = {
  'iceServers': [
    {
      'urls': 'stun:coturn.clipora.cc:23388',
    },
    {
      'urls': 'turn:coturn.clipora.cc:23388',
      'username': 'clipora',
      'credential': 'clipora123',
    },
  ],
  'iceCandidatePoolSize': 10,
};
```

### 信令消息类型

- **join-room**: 加入房间
- **leave-room**: 离开房间
- **offer**: SDP Offer
- **answer**: SDP Answer
- **ice-candidate**: ICE 候选者
- **user-joined**: 用户加入通知
- **user-left**: 用户离开通知
- **room-users**: 房间用户列表

### 数据通道

- 使用 RTCDataChannel 进行数据传输
- 支持文本和二进制数据
- 自动处理连接状态变化

### 文件处理

- 文件通过 base64 编码传输
- 接收的文件保存到应用文档目录
- 支持任意类型的文件传输

## 架构说明

```
┌─────────────────┐    WebSocket     ┌─────────────────┐
│   Flutter App A │ ←──────────────→ │   信令服务器    │
└─────────────────┘                  └─────────────────┘
         │                                    ↑
         │                                    │ WebSocket
         │ WebRTC P2P                         │
         │ (文件数据)                         │
         ↓                                    │
┌─────────────────┐                  ┌─────────────────┐
│   Flutter App B │ ←──────────────→ │   Flutter App C │
└─────────────────┘    WebSocket     └─────────────────┘
```

## 依赖项

```yaml
dependencies:
  flutter_webrtc: 0.12.11
  web_socket_channel: ^3.0.1
  path_provider: ^2.1.5
```

## 注意事项

- 需要网络连接建立 WebRTC 连接
- 信令服务器需要可访问 (111.230.32.118:8000)
- STUN/TURN 服务器需要可访问 (coturn.clipora.cc:23388)
- 大文件传输可能需要较长时间
- 建议在同一网络环境下使用以获得最佳性能

## 故障排除

### 信令服务器连接失败
- 检查网络连接
- 确认服务器地址和端口正确
- 检查防火墙设置

### WebRTC连接失败
- 确保信令服务器连接正常
- 检查 STUN/TURN 服务器可访问性
- 查看日志获取详细错误信息

### 文件传输失败
- 确认WebRTC连接状态为"已连接"
- 检查文件大小限制
- 查看日志获取详细错误信息