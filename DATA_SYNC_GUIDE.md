# 数据同步功能使用指南

## 功能介绍

数据同步功能已成功集成到应用中，允许用户在不同设备间进行点对点的文件传输和数据同步。

## 如何访问

1. 打开应用
2. 进入"设置"页面（我的页面）
3. 在"应用功能"部分找到"数据同步"选项
4. 点击进入数据同步页面

## 功能特性

### ✅ 已实现功能

- **WebRTC 点对点连接**: 使用 flutter_webrtc 0.12.11 实现
- **连接状态显示**: 实时显示连接状态（未连接、连接中、已连接等）
- **SDP 信息交换**: 通过手动复制粘贴 SDP 信息建立连接
- **文件传输**: 支持文本消息和文件的发送接收
- **实时日志**: 显示详细的连接和传输日志
- **现代化UI**: 符合应用整体设计风格的用户界面

### 🔧 技术实现

- **信令服务器**: 使用专用信令服务器 (111.230.32.118:8000)
- **STUN/TURN 服务器**: 使用 coturn.clipora.cc:23388 进行 NAT 穿透
- **房间管理**: 支持多房间，用户可以加入/离开房间
- **数据通道**: RTCDataChannel 用于数据传输
- **文件编码**: Base64 编码传输文件
- **存储位置**: 接收的文件保存到应用文档目录

## 使用步骤

### 建立连接

1. **连接信令服务器**:
   - 打开数据同步页面
   - 点击"连接信令服务器"按钮
   - 等待连接状态显示为"已连接"

2. **加入房间**:
   - 输入房间ID（或使用默认生成的房间ID）
   - 点击"加入房间"按钮
   - 等待其他用户加入同一房间

3. **建立WebRTC连接**:
   - 从用户列表中选择目标用户
   - 点击"建立WebRTC连接"按钮
   - 等待WebRTC连接状态显示为"已连接"

### 数据传输

- **测试连接**: 点击"发送测试"发送测试消息
- **文件传输**: 点击"发送文件"发送示例文件

## 后续扩展计划

### 🚀 即将实现

1. **STUN/TURN 服务器配置**
   - 支持自定义 STUN/TURN 服务器
   - 提供服务器配置界面

2. **文件选择器**
   - 支持从设备选择任意文件
   - 多文件同时传输

3. **传输进度**
   - 显示文件传输进度
   - 支持大文件传输

4. **连接管理**
   - 保存常用连接
   - 自动重连功能

### 🔒 安全增强

- 端到端加密
- 连接验证机制
- 传输完整性校验

## 开发信息

### 文件结构
```
lib/view/data_sync/
├── data_sync_page.dart     # 主页面实现
└── README.md              # 技术文档
```

### 路由配置
- 路由名称: `dataSync`
- 路径: `/data_sync`
- 入口: 设置页面 → 数据同步

### 依赖项
- `flutter_webrtc: 0.12.11`
- `web_socket_channel: ^3.0.1`
- `path_provider: ^2.1.5`

## 注意事项

1. **网络要求**: 需要互联网连接建立 WebRTC 连接
2. **防火墙**: 某些网络环境可能需要配置防火墙规则
3. **性能**: 大文件传输建议在同一网络环境下进行
4. **兼容性**: 支持 Android 和 iOS 平台

## 故障排除

### 🔧 新增诊断工具

应用现在包含了网络诊断功能：
- **测试STUN**: 检查STUN服务器连通性
- **测试TURN**: 检查TURN服务器认证和连通性
- **详细日志**: 显示完整的连接过程和错误信息

### 📋 故障排除步骤

#### 1. 信令服务器连接失败
```
现象: 信令服务器状态显示"连接失败"
排查步骤:
1. 检查网络连接是否正常
2. 确认服务器地址 111.230.32.118:8000 可访问
3. 检查防火墙是否阻止连接
4. 查看详细错误日志
```

#### 2. WebRTC连接失败
```
现象: WebRTC连接状态显示"连接失败"
排查步骤:
1. 先点击"测试STUN"按钮，检查STUN服务器
2. 点击"测试TURN"按钮，检查TURN服务器
3. 确保信令服务器连接正常
4. 检查ICE候选者收集是否成功
5. 查看详细的连接日志
```

#### 3. STUN/TURN服务器问题
```
现象: 测试STUN/TURN超时或失败
可能原因:
- 服务器 coturn.clipora.cc:23388 不可达
- TURN认证失败（用户名/密码错误）
- 防火墙阻止UDP连接
- 网络NAT类型不支持
```

#### 4. 文件传输失败
```
现象: 无法发送文件或消息
排查步骤:
1. 确认WebRTC连接状态为"已连接"
2. 检查数据通道状态
3. 查看传输错误日志
```

### 🔍 详细诊断信息

新版本提供了更详细的诊断信息：

- **连接状态变化**: 实时显示WebRTC连接状态
- **ICE候选者信息**: 显示收集到的网络候选者类型
- **错误详情**: 显示具体的错误原因和建议
- **网络测试**: 独立测试STUN/TURN服务器连通性

### 📞 技术支持

如果问题仍然存在，请提供以下信息：
1. 详细的连接日志
2. 网络环境描述（WiFi/移动网络/企业网络）
3. 设备型号和系统版本
4. STUN/TURN测试结果

---

**开发完成时间**: 2025年8月15日  
**版本**: v1.0.0  
**状态**: ✅ 基础功能完成，可正常使用